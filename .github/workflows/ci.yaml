name: Build extension and publish to Marketplace

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # Run tests and linting on all pushes and PRs
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run compile

      - name: Run linter
        run: npm run lint

      - name: Setup virtual display for VS Code tests
        run: |
          /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Run tests
        run: npm test
        env:
          DISPLAY: ':99.0'

  # Release Please handles version bumps and changelog
  release-please:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: test
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      release_tag_name: ${{ steps.release.outputs.tag_name }}
      release_version: ${{ steps.release.outputs.version }}
      release_upload_url: ${{ steps.release.outputs.upload_url }}
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Run Release Please
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release
        with:
          token: ${{ secrets.RELEASE_PLEASE_PAT || github.token }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Show Release Please output
        if: always()
        run: |
          echo "releases_created: ${{ steps.release.outputs.releases_created }}"
          echo "release_created: ${{ steps.release.outputs.release_created }}"
          echo "tag_name: ${{ steps.release.outputs.tag_name }}"
          echo "version: ${{ steps.release.outputs.version }}"
          echo "upload_url: ${{ steps.release.outputs.upload_url }}"

  # Package and publish the extension
  publish:
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Security scan - Check for sensitive files in package
        run: |
          echo "ðŸ” Scanning extension package for sensitive files..."

          # Get list of files that will be included in the package
          FILES=$(vsce ls 2>/dev/null)

          # Define patterns for sensitive files
          SENSITIVE_PATTERNS=(
            "\.env$"
            "\.env\."
            "\.envrc$"
            "\.pem$"
            "\.key$"
            "\.p12$"
            "\.pfx$"
            "\.cer$"
            "\.crt$"
            "\.der$"
            "id_rsa"
            "id_dsa"
            "id_ecdsa"
            "id_ed25519"
            "credentials\.json$"
            "service-account.*\.json$"
            "gcloud\.json$"
            "aws-credentials"
            "\.npmrc$"
            "\.pypirc$"
            "\.dockercfg$"
            "privatekey"
            "private\.key"
            "password"
            "secrets\."
            "auth\.json$"
            "\.db$"
            "\.sqlite$"
            "\.sqlite3$"
            "token"
            "\.bak$"
            "\.backup$"
          )

          FOUND_SENSITIVE=0
          SENSITIVE_FILES=()

          # Check each file against sensitive patterns
          while IFS= read -r file; do
            for pattern in "${SENSITIVE_PATTERNS[@]}"; do
              if echo "$file" | grep -iE "$pattern" > /dev/null; then
                SENSITIVE_FILES+=("$file")
                FOUND_SENSITIVE=1
                break
              fi
            done
          done <<< "$FILES"

          # Report results
          if [ $FOUND_SENSITIVE -eq 1 ]; then
            echo "âŒ ERROR: Sensitive files detected in extension package!"
            echo ""
            echo "The following sensitive files would be included in the published extension:"
            printf '  - %s\n' "${SENSITIVE_FILES[@]}"
            echo ""
            echo "These files may contain:"
            echo "  â€¢ API keys, tokens, or credentials"
            echo "  â€¢ Private certificates or SSH keys"
            echo "  â€¢ Environment configuration"
            echo "  â€¢ Database files with sensitive data"
            echo ""
            echo "Action required:"
            echo "  1. Add these files to .vscodeignore"
            echo "  2. Verify no sensitive data is committed to the repository"
            echo "  3. Rotate any exposed credentials"
            echo ""
            echo "ðŸš¨ Publishing has been blocked to prevent credential exposure!"
            exit 1
          else
            echo "âœ… No sensitive files detected in package"
            echo "ðŸ“¦ Package contains $(echo "$FILES" | wc -l | tr -d ' ') files"
          fi

      - name: Package extension
        run: vsce package

      - name: Get VSIX filename
        id: vsix
        run: |
          VSIX_FILE=$(ls *.vsix)
          echo "filename=$VSIX_FILE" >> $GITHUB_OUTPUT
          echo "Found VSIX: $VSIX_FILE"

      - name: Upload VSIX to GitHub Release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          allowUpdates: true
          omitBodyDuringUpdate: true
          omitNameDuringUpdate: true
          artifactContentType: application/vsix
          tag: ${{ needs.release-please.outputs.release_tag_name }}
          artifacts: ${{ steps.vsix.outputs.filename }}
          token: ${{ github.token }}

      # Publish to VS Code Marketplace
      # Uncomment when you have VSCE_PAT secret configured
      - name: Publish to VS Code Marketplace
        run: vsce publish -p ${{ secrets.VSCE_PAT }}

      # Optional: Publish to Open VSX Registry
      # - name: Publish to Open VSX
      #   uses: HaaLeo/publish-vscode-extension@v1
      #   with:
      #     pat: ${{ secrets.OPEN_VSX_TOKEN }}
      #     extensionFile: ${{ steps.vsix.outputs.filename }}
      #     registryUrl: https://open-vsx.org

  # Generate SBOM for security compliance
  sbom:
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate SBOM
        run: |
          curl -L -o $RUNNER_TEMP/sbom-tool \
            https://github.com/microsoft/sbom-tool/releases/download/v2.2.8/sbom-tool-linux-x64
          chmod +x $RUNNER_TEMP/sbom-tool

          mkdir -p ./build
          $RUNNER_TEMP/sbom-tool generate \
            -b ./build \
            -bc . \
            -pn ctrl-q-qvd-viewer \
            -pv ${{ needs.release-please.outputs.release_version }} \
            -ps "Ptarmigan Labs" \
            -nsb https://sbom.ptarmiganlabs.com \
            -V verbose

      - name: Upload SBOM to Release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          allowUpdates: true
          omitBodyDuringUpdate: true
          omitNameDuringUpdate: true
          tag: ${{ needs.release-please.outputs.release_tag_name }}
          artifacts: './build/**/*.spdx.json'
          token: ${{ github.token }}
