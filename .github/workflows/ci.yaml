name: Build extension and publish to Marketplace

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # Run tests and linting on all pushes and PRs
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Setup virtual display for VS Code tests
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Run tests
        run: xvfb-run -a npm test

  # Release Please handles version bumps and changelog
  release-please:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: test
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      release_tag_name: ${{ steps.release.outputs.tag_name }}
      release_version: ${{ steps.release.outputs.version }}
      release_upload_url: ${{ steps.release.outputs.upload_url }}
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Run Release Please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.RELEASE_PLEASE_PAT || github.token }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Show Release Please output
        if: always()
        run: |
          echo "releases_created: ${{ steps.release.outputs.releases_created }}"
          echo "release_created: ${{ steps.release.outputs.release_created }}"
          echo "tag_name: ${{ steps.release.outputs.tag_name }}"
          echo "version: ${{ steps.release.outputs.version }}"
          echo "upload_url: ${{ steps.release.outputs.upload_url }}"

  # Package and publish the extension
  publish:
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package extension
        run: vsce package

      - name: Get VSIX filename
        id: vsix
        run: |
          VSIX_FILE=$(ls *.vsix)
          echo "filename=$VSIX_FILE" >> $GITHUB_OUTPUT
          echo "Found VSIX: $VSIX_FILE"

      - name: Upload VSIX to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          omitBodyDuringUpdate: true
          omitNameDuringUpdate: true
          artifactContentType: application/vsix
          tag: ${{ needs.release-please.outputs.release_tag_name }}
          artifacts: ${{ steps.vsix.outputs.filename }}
          token: ${{ github.token }}

      # Publish to VS Code Marketplace
      # Uncomment when you have VSCE_PAT secret configured
      - name: Publish to VS Code Marketplace
        run: vsce publish -p ${{ secrets.VSCE_PAT }}

      # Optional: Publish to Open VSX Registry
      # - name: Publish to Open VSX
      #   uses: HaaLeo/publish-vscode-extension@v1
      #   with:
      #     pat: ${{ secrets.OPEN_VSX_TOKEN }}
      #     extensionFile: ${{ steps.vsix.outputs.filename }}
      #     registryUrl: https://open-vsx.org

  # Generate SBOM for security compliance
  sbom:
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate SBOM
        run: |
          curl -Lo $RUNNER_TEMP/sbom-tool \
            https://github.com/microsoft/sbom-tool/releases/latest/download/sbom-tool-linux-x64
          chmod +x $RUNNER_TEMP/sbom-tool

          mkdir -p ./build
          $RUNNER_TEMP/sbom-tool generate \
            -b ./build \
            -bc . \
            -pn ctrl-q-qvd-viewer \
            -pv ${{ needs.release-please.outputs.release_version }} \
            -ps "Ptarmigan Labs" \
            -nsb https://sbom.ptarmiganlabs.com \
            -V verbose

      - name: Upload SBOM to Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          omitBodyDuringUpdate: true
          omitNameDuringUpdate: true
          tag: ${{ needs.release-please.outputs.release_tag_name }}
          artifacts: './build/**/*.spdx.json'
          token: ${{ github.token }}
